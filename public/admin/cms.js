/* public/admin/cms.js
   This file is loaded automatically by  public/admin/index.html
   (add   <script src="/admin/cms.js"></script>  before the closing </body> tag
   if you haven’t done so yet). */

import CMS from "netlify-cms-app";

/* ─── 1.  Fetch the block names generated by the script ─── */
fetch("/blocks.json")
  .then((r) => r.json())
  .then((blocks) => {
    /* ─── 2.  Register a custom <select> that shows them ─── */
    CMS.registerWidget(
      "blocks-select",
      createControl(blocks),
      createPreview
    );
  });
/* ------------- Blog post preview ---------------- */
CMS.registerPreviewTemplate("posts", ({ entry }) => {
  const data  = entry.getIn(["data"]).toJS();
  return (
    <article className="prose lg:prose-lg mx-auto p-8">
      <h1>{data.title}</h1>
      <p><em>{data.date}</em></p>
      <div dangerouslySetInnerHTML={{ __html: data.body }} />
    </article>
  );
});
/* ---------- helpers ---------- */
function createControl(blocks) {
  return class BlocksSelectControl extends React.Component {
    handle = (e) => this.props.onChange(e.target.value);
    render() {
      return (
        <select className="nc-controlSelect" value={this.props.value || ""} onChange={this.handle}>
          <option value="">— choose block —</option>
          {blocks.map((b) => (
            <option key={b.name} value={b.name}>
              {b.name}
            </option>
          ))}
        </select>
      );
    }
  };
}

function createPreview() {
  return ({ value }) => (
    <div style={{ padding: "6px 10px", border: "1px solid #ddd", background: "#fafafa" }}>
      {value || "Block"}
    </div>
  );
}
